<html>
<head>
<title>role.organizer.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.ln { color: rgb(0,0,0); font-weight: normal; font-style: normal; }
.s0 { color: rgb(0,0,0); }
.s1 { color: rgb(128,128,128); font-style: italic; }
.s2 { color: rgb(0,0,128); font-weight: bold; }
.s3 { color: rgb(0,128,0); font-weight: bold; }
.s4 { color: rgb(0,0,255); }
</style>
</head>
<BODY BGCOLOR="#ffffff">
<TABLE CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#C0C0C0" >
<TR><TD><CENTER>
<FONT FACE="Arial, Helvetica" COLOR="#000000">
role.organizer.js</FONT>
</center></TD></TR></TABLE>
<pre>
            <span class="s1">/*/** 
             * Organizer role manages the memory of the creeps and buildings 
             */</span><span class="s0"> 
            </span><span class="s2">var </span><span class="s0">roleOrganizer = { 
                run: </span><span class="s2">function </span><span class="s0">(creep) { 
                    </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">id </span><span class="s2">in </span><span class="s0">Game.rooms) { 
                        </span><span class="s2">var </span><span class="s0">room = Game.rooms[id]; 
                        </span><span class="s2">if </span><span class="s0">(!Memory.rooms[room.name]) { 
                            Memory.rooms[room.name] = {};   </span><span class="s1">//Memory Room Name</span><span class="s0"> 
                        } 
                        </span><span class="s2">else </span><span class="s0">{ 
                            </span><span class="s2">var </span><span class="s0">buildings = room.find(FIND_MY_STRUCTURES); 
                            </span><span class="s2">var </span><span class="s0">controllers = room.find(FIND_STRUCTURES, { 
                                filter: {structureType: STRUCTURE_CONTROLLER} 
                            }); 
                            </span><span class="s2">if </span><span class="s0">(!Memory.rooms[room.name].structures) { 
                                Memory.rooms[room.name].structures = [];    </span><span class="s1">//[room.name].structures</span><span class="s0"> 
                            } 
                            </span><span class="s2">else </span><span class="s0">{ 
                                </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">ids </span><span class="s2">in </span><span class="s0">buildings) { 
                                    </span><span class="s2">var </span><span class="s0">structureType = buildings[ids].structureType; 
                                    </span><span class="s2">var </span><span class="s0">id = buildings[ids].id; 
                                    </span><span class="s2">var </span><span class="s0">name = buildings[ids].name; 
                                    </span><span class="s2">if </span><span class="s0">(!(buildings[ids].structureType == </span><span class="s3">'spawn' </span><span class="s0">|| buildings[ids].structureType == </span><span class="s3">'extension' </span><span class="s0">)) { 
                                        Memory.rooms[room.name].structures.push({id: id, structureType: structureType}); 
                                    } 
                                    </span><span class="s2">else </span><span class="s0">{ 
                                        </span><span class="s2">if </span><span class="s0">(buildings[ids].structureType == </span><span class="s3">'spawn'</span><span class="s0">) { 
                                            </span><span class="s2">var </span><span class="s0">controllers = buildings[ids].pos.findInRange(FIND_MY_STRUCTURES, </span><span class="s4">4</span><span class="s0">, {filter: {structureType: STRUCTURE_EXTENSION}}).length; 
                                            Memory.rooms[room.name].structures.push({ 
                                                id: id, 
                                                name: name, 
                                                structureType: structureType, 
                                                controllers: controllers 
                                            }); 
                                        } 
                                    } 
 
                                } 
                            } 
                            </span><span class="s2">if </span><span class="s0">(!Memory.rooms[room.name].architectLog) { 
                                Memory.rooms[room.name].architectLog = [];  </span><span class="s1">//[room.name].architectLog</span><span class="s0"> 
                                </span><span class="s2">var </span><span class="s0">resourceRoutes = []; 
                                </span><span class="s2">var </span><span class="s0">haulerQueues = []; 
                                Memory.rooms[room.name].architectLog.push(resourceRoutes, haulerQueues); 
                                </span><span class="s2">var </span><span class="s0">resources = room.find(FIND_SOURCES); 
                                </span><span class="s1">/*Log sources*/</span><span class="s0"> 
                                </span><span class="s2">if </span><span class="s0">(!Memory.rooms[room.name].sources) { 
                                    Memory.rooms[room.name].sources = []; 
                                    </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">ids </span><span class="s2">in </span><span class="s0">resources) { 
                                        </span><span class="s2">var </span><span class="s0">source = {}; 
                                        </span><span class="s2">var </span><span class="s0">klair = resources[ids].pos.findInRange(FIND_STRUCTURES, </span><span class="s4">6</span><span class="s0">, {filter: {structureType: STRUCTURE_KEEPER_LAIR}}).length &gt; </span><span class="s4">0</span><span class="s0">; 
                                        source.id = resources[ids].id; 
                                        </span><span class="s2">var </span><span class="s0">resourceObject = Game.getObjectById(resources[ids].id); 
                                        </span><span class="s2">var </span><span class="s0">resourceArea = creep.room.lookAtArea((resourceObject.pos.y - </span><span class="s4">1</span><span class="s0">), (resourceObject.pos.x - </span><span class="s4">1</span><span class="s0">), (resourceObject.pos.y + </span><span class="s4">1</span><span class="s0">), (resourceObject.pos.x + </span><span class="s4">1</span><span class="s0">), </span><span class="s2">true</span><span class="s0">); 
                                        </span><span class="s2">var </span><span class="s0">freeSlots = </span><span class="s4">9</span><span class="s0">; 
                                        </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">i = </span><span class="s4">1</span><span class="s0">; i &lt; resourceArea.length; i++) { 
                                            </span><span class="s2">if </span><span class="s0">(resourceArea[i].terrain == </span><span class="s3">'wall'</span><span class="s0">) { 
                                                freeSlots--; 
                                            } 
                                        } 
                                        source.totalSlots = freeSlots; 
                                        source.slotsRemaining = freeSlots; 
                                        source.klair = klair; 
                                        source.status = </span><span class="s3">'Inactive'</span><span class="s0">; 
                                        Memory.rooms[room.name].sources.push(source); 
                                    } 
                                } 
                                Memory.rooms[room.name].sources[</span><span class="s4">0</span><span class="s0">].status = </span><span class="s3">'Active'</span><span class="s0">;  </span><span class="s1">//Activate first source</span><span class="s0"> 
                            } 
                            </span><span class="s1">// List creeps by role</span><span class="s0"> 
                            </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">cid </span><span class="s2">in </span><span class="s0">Memory.creeps) { 
                                </span><span class="s2">if </span><span class="s0">(!Memory.roles) { 
                                    Memory.roles = {}; 
                                    Memory.roles.builders = {}; 
                                    Memory.roles.harvesters = {}; 
                                    Memory.roles.haulers = {}; 
                                    Memory.roles.organizers = {}; 
                                    Memory.roles.upgraders = {}; 
                                    </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">i </span><span class="s2">in </span><span class="s0">Memory.roles) { 
                                        </span><span class="s2">var </span><span class="s0">roleNames = i.substr(</span><span class="s4">0</span><span class="s0">, (i.length - </span><span class="s4">1</span><span class="s0">)); 
                                        Memory.roles[i].id = roleNames; 
                                        Memory.roles[i].members = []; 
                                    } 
                                } 
                                </span><span class="s2">else </span><span class="s0">{ 
                                    </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">i </span><span class="s2">in </span><span class="s0">Memory.roles) { 
                                        </span><span class="s2">if </span><span class="s0">(Memory.roles[i].id == Memory.creeps[cid].role) { 
                                            </span><span class="s2">var </span><span class="s0">creepExists = </span><span class="s2">false</span><span class="s0">; 
                                            </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">j = </span><span class="s4">0</span><span class="s0">; j &lt; Memory.roles[i].members.length; j++) { 
                                                </span><span class="s2">if </span><span class="s0">(Memory.roles[i].members[j] == cid) { 
                                                    creepExists = </span><span class="s2">true</span><span class="s0">; 
                                                } 
                                            } 
                                            </span><span class="s2">if </span><span class="s0">(creepExists == </span><span class="s2">false</span><span class="s0">) { 
                                                Memory.roles[i].members.push(cid) 
                                            } 
                                        } 
                                    } 
                                } 
                            } 
                            </span><span class="s1">//Activate sources</span><span class="s0"> 
                            </span><span class="s2">var </span><span class="s0">activateNext = </span><span class="s2">false</span><span class="s0">; 
                            </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">j = </span><span class="s4">0</span><span class="s0">; j &lt; Memory.rooms[room.name].sources.length; j++) { 
                                </span><span class="s2">if </span><span class="s0">(Memory.rooms[room.name].sources[j].status == </span><span class="s3">'Active' </span><span class="s0">&amp;&amp; Memory.rooms[room.name].sources[j].slotsRemaining == </span><span class="s4">0</span><span class="s0">) { 
                                    activateNext = </span><span class="s2">true</span><span class="s0">; 
                                } 
                                </span><span class="s2">if </span><span class="s0">(Memory.rooms[room.name].sources[j].status == </span><span class="s3">'Inactive' </span><span class="s0">&amp;&amp; activateNext == </span><span class="s2">true</span><span class="s0">) { 
                                    Memory.rooms[room.name].sources[j].status = </span><span class="s3">'Active'</span><span class="s0">; 
                                } 
                            } 
                            </span><span class="s1">//Assign source to harvester</span><span class="s0"> 
                            </span><span class="s2">if </span><span class="s0">(Memory.creeps[cid].role == </span><span class="s3">'harvester'</span><span class="s0">) { 
                                </span><span class="s2">if </span><span class="s0">(!Memory.creeps[cid].workLog) { 
                                    Memory.creeps[cid].workLog = {}; 
                                } 
                                </span><span class="s2">else </span><span class="s0">{ 
                                    </span><span class="s1">/*Looking for source*/</span><span class="s0"> 
                                    </span><span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">j = </span><span class="s4">0</span><span class="s0">; j &lt; Memory.rooms[room.name].sources.length; j++) { 
                                        </span><span class="s2">if </span><span class="s0">(Memory.rooms[room.name].sources[j].slotsRemaining &gt; </span><span class="s4">0 </span><span class="s0">&amp;&amp; Memory.rooms[room.name].sources[j].klair == </span><span class="s2">false </span><span class="s0">&amp;&amp; Memory.rooms[room.name].sources[j].status == </span><span class="s3">'Active'</span><span class="s0">) { 
                                            Memory.rooms[room.name].sources[j].slotsRemaining--; 
                                            Memory.creeps[cid].workLog.energyCollected = </span><span class="s4">0</span><span class="s0">; 
                                            Memory.creeps[cid].workLog.sources = Memory.rooms[room.name].sources[j].id; 
                                            </span><span class="s2">break</span><span class="s0">; 
                                        } 
                                    } 
                                } 
                            } 
                        } 
                    } 
                } 
                }; 
 
            module.exports = roleOrganizer;</span></pre>
</body>
</html>